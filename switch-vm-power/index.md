---
layout: default
title: Azure の外部から Azure 仮想マシンの電源を上げ下げするサンプルスクリプト
---

## 背景

同僚に以下のような依頼をされてちょろっと作ったサンプルスクリプトです。

- Azure 仮想マシンの電源を自動で上げ下げしたい
- Azure 外部から実行できるようにしたい
- スケジューラは別途用意するので考えなくてよい

これなら Azure AD にサービスプリンシパル作っておいて、それ使って Connect-AzAccount して Start-AzVM とか Stop-AzVM とかすれば出来るっしょ、と安請け合いしたものです。
まあその通りではあったのですが、久しぶりにコーディングすると地味にはまりますね・・・。
内容は[成果物](./switch-vmpower.ps1) をご参照いただければと思います。

[Azure PowerShell 6.1.0](https://docs.microsoft.com/ja-jp/powershell/azure/?view=azps-6.1.0) がインストールされている環境であれば動作するはず。
サービスプリンシパルを１つ作成して、対象となる仮想マシンに対して共同作成者等の役割を割り当て、あとはそれらの情報をスクリプトの引数に与えてやればＯＫです。
