---
layout: default
title: SLA の A は Availability（可用性）ではなく Agreement （合意）です
---

# はじめに

Microsoft Azure に限りませんが、有償のクラウドサービスを利用する場合には SLA : Service Level Agreement が定義されていることが多いです。
クラウドが普及し始めた初期の頃こそ「えすえるえー？ 何それ美味しいの？」という会話も割と多かったのですが、最近では減ってきて利用者の側でも SLA を意識されるようになってきたなあという印象があります。
とはいえ会話を進めていくと "SLA" という言葉の捉え方、その数値（99.9%とか）の解釈、違反が発生したらどうなるか？などがすれ違いを起こしていることも割とよくあります。
というわけで、この記事では私がお客様と「SLA」について会話する際にトピックになりがちな内容をつらつらと書いて行こうと思います。

一部には私の独断と偏見が含まれていますのでご注意ください。

# Service Level Agreement とは何か

言葉の定義だけを振り回すのはあまり好きではないですし、会社やサービスによって SLA で設定されているものが異なったりするので、
差し当たり [Microsoft Azure の SLA](https://azure.microsoft.com/ja-jp/support/legal/sla/) をみてみましょう。

> SLA をお読みになり、マイクロソフトの稼働時間の保証およびダウンタイムのクレジット ポリシーについてご確認ください。

保証及びクレジット（返金）のポリシー、すなわちお金を支払ってご利用いただいたサービスに対して、保証した稼働率を下回った場合の罰則規定を定めたものです。
誤解されがちですが SLA の **A** は稼働率や可用性の実績（Availability）ではないのです。
ユーザーさんがサービスの利用にあたってご確認および同意（Agreement）いただくものです。

当然クラウドプロバイダーとしては返金などしたくありません。
実稼働率である SLI : Service Level Indicator は SLA を上回っているのが普通の状態です。
もちろん一時的に下回ることはありえますが、多くの月において SLA は達成しているのではないでしょうか。
じゃないと商売にならないわけですし。
なお残念ながら Microsoft は Azure における各サービスの実稼働率を公表していませんので、具体的な数値をここで示すことは出来ません。（私にそんな権限も無いのでデータ自体を持ってないのですが）

また SLI が常に SLA を上回るように、運用目標である SLO : Service Level Objective も高く設定されています。
SLA を満たしていたとしても障害が発生すればクラウドプロバイダーとしての信頼性が問われます。
そのために日々の運用や機能の改善が継続的が行われているわけです。
この取り組みについては少し古い記事になりますが [Microsoft Azure の信頼性をさらに高める](https://azure.microsoft.com/ja-jp/blog/advancing-microsoft-azure-reliability/) が参考になるでしょうか。
ここでいう信頼性とは可用性だけではなく、セキュリティなどの要素も含んでいます。

検索していただく SLA、SLI、SLO の違いについてはと様々な情報が得られます。
用語の定義ももちろん重要ですが、人によって異なるニュアンスで使われることが割と多いので、今話しているのは SLA なのか、SLI なのか、SLO なのか、共通認識を持って会話することが重要だと考えます。

# 適切な SLO ってどれくらい？

何かしら必要があるからシステムが構築され運用されているわけですから、落ちてもいいシステムというのは基本的には無いと思います。
とはいえどうしたって事故は起こりますので、可用性 100％ は現実的ではなく、リスクは常にあるという意識が必要でしょう。
また可用性を高くするためには設計・構築・運用に必要なコストはどんどん高くなります。
つまり可用性とそのコストに対して、システムから得られる利益のバランスが重要です。

では、どれくらいに設定するのがいいのでしょうか。
これは一律の答えがあるわけでは無いのですが、例えば以下が参考になりますでしょうか。

![](./images/availability-sample.png)

なおこれは縦軸が Availability であること、つまり必ずしも Agreement であることを意味していません。
SLA を設定するということは前述の通り罰則規定を伴い、また違反時には改善が必須となることを意味しますのでご注意ください。

# Azure　Cosmos　DB の SLA　は ９９.９９９％ （ファイブナイン） 

さて少し具体的に [Cosmos DB の SLA](https://azure.microsoft.com/ja-jp/support/legal/sla/cosmos-db) を見てみましょう。
下記は 2022 年 8 月時点の version 1.4 の内容（この時点での最終更新は 2021 年 5 月）から抜粋したものです。
正確な内容は是非リンク先をご自身の目でご確認ください。

> Azure Cosmos DB は、データベース アカウント用の書き込み可能なエンドポイントとして複数の Azure リージョンの構成を可能にします。
> この構成では、Azure Cosmos DB は、読み取りと書き込みの両方において 99.999% SLA の可用性を提供します。

SLA に関する会話をしていると、この `99.999%` という数値が着目されるのですが（別にそれは間違いではないのですが）解釈に注意する必要があります。

まずこの百分率で表された数値の分子と分母は何か？です。
SLA ドキュメントの中の「SLA の詳細」を展開してみると詳細な記載があるのですが、これは Cosmos DB に対して行われた「読み取りや書き込みの総数及びエラーになった回数」で算出されます。
正常に接続できる **時間ではない** のです。

これはあくまでも例え話になりますが、ある月のある１時間の間にずっと満遍なくエラーが出ていた、ただし要求の一部だけがエラーになるのであって、正常に完了した要求はたくさんあるものとします。
エラーは１秒間に１回（1 時間で 3,600 回）出ていて、ただ並行して正常に処理された要求も 1,000,000 回あったとしましょう。
つまりこの時間のエラー率は 0.3587 % です。
正常に処理できている割合は 99.65 % です。
割とダメな感じです。

$$
エラー率 = \frac{3600}{1 000 000 + 3600} = 0.3587 \%
$$

ただし、Cosmos DB の SLA における **月間稼働率** は請求月間内の各時間における平均エラー率から算出されます。
わかりにくいですね。
上記はあくまでも「とある１時間」における話なので、他の時間帯は全て正常に要求を処理できていた、すなわちエラー率が 0 % だとしたらどうでしょう。
１ヶ月を 30 日とすると 720 時間ですので、平均エラー率は 0.000498% になります。

$$
平均エラー率 = \frac{ 3.47\% + 0\%+ 0\%+ 0\% + ...}{30 \times 24} = 0.000498 \%
$$

つまり月間稼働率は 99.9995 % ですので、SLA を達成していることになります。
返金対象にはなりません。

$$
月間稼働率 = 100 \% - 0.000498 \% = 99.9995 \% > 99.999 \%
$$

ちなみに前述のエラーが出ていた時間帯以外に全く要求がない、つまり要求数がゼロなのでエラーも正常もない場合には、その時間帯のエラー率は 0% になります。
月に一回だけ実行する一時間で完結する月次バッチ処理とかだとこういうこともあり得ます。

納得いきますか？
私は「SLA 99.999% という表現から受ける印象とは大分異なるな？」と感じました。
しかし SLA の定義からは上記のような計算になってしまうわけです。

# SLA の適用が除外されることこともある

# どれくらい返金されるの？

# その SLA　は誰が同意したの？